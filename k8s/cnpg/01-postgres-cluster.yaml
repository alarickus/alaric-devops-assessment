
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: mirror-db
  namespace: mirror-app
  labels:
    app: mirror-db
spec:
  instances: 2
  
  imageName: ghcr.io/cloudnative-pg/postgresql:14.10
  
  postgresql:
    parameters:
      max_connections: "100"            # Reduced from 200
      shared_buffers: "128MB"           # Reduced from 256MB
      effective_cache_size: "384MB"     # Reduced from 768MB
      maintenance_work_mem: "32MB"      # Reduced from 64MB
      checkpoint_completion_target: "0.9"
      wal_buffers: "8MB"                # Reduced from 16MB
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "655kB"                 # Reduced from 1310kB
      min_wal_size: "512MB"             # Reduced from 1GB
      max_wal_size: "2GB"               # Reduced from 4GB
  
  bootstrap:
    initdb:
      database: mirrordb
      owner: app
      secret:
        name: db-credentials
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
        - |
          CREATE TABLE IF NOT EXISTS mirror_words (
            id SERIAL PRIMARY KEY,
            original_word VARCHAR(255) NOT NULL,
            transformed_word VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
        - CREATE INDEX IF NOT EXISTS idx_mirror_words_original ON mirror_words(original_word);
  
  storage:
    size: 5Gi  # Reduced from 10Gi
    storageClass: managed-premium  # Azure Premium SSD for better performance
  
  resources:
    requests:
      memory: "256Mi"  # Reduced from 512Mi
      cpu: "100m"      # Reduced from 250m
    limits:
      memory: "512Mi"  # Reduced from 1Gi
      cpu: "500m"      # Reduced from 1000m
  
  primaryUpdateStrategy: unsupervised
  maxSyncReplicas: 1  # Only 1 replica total
  minSyncReplicas: 0  # Allow async for better performance

  
  superuserSecret:
    name: db-superuser
  


---

---

---
